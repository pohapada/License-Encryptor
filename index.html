<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SpiderTrader License Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Reset and Base Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    :root {
      --primary: #3b82f6;
      --primary-light: #93c5fd;
      --secondary: #10b981;
      --secondary-light: #6ee7b7;
      --gray: #f3f4f6;
      --dark-gray: #e5e7eb;
      --text: #1f2937;
      --text-light: #6b7280;
      --card-bg: #ffffff;
      --shadow: rgba(0, 0, 0, 0.08);
      --error: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
      --card-border: rgba(0, 0, 0, 0.05);
      --card-gradient: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      --transition: all 0.3s ease;
      --purple: #8b5cf6;
      --purple-light: #c4b5fd;
      --gold: #FFD700;
      --silver: #C0C0C0;
      --dark-blue: #0c1d2f;
      --darker-blue: #091928;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--gray);
      color: var(--text);
      background-image: radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.08) 0%, transparent 25%),
                       radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.08) 0%, transparent 25%);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
    }
    
    /* Header Styles */
    header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .logo-container {
      display: inline-flex;
      align-items: center;
      gap: 15px;
      background: rgba(255, 255, 255, 0.9);
      padding: 15px 30px;
      border-radius: 50px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .logo {
      width: 60px;
      height: 60px;
      background: var(--primary);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 15px rgba(59, 130, 246, 0.3);
    }
    
    .logo i {
      font-size: 28px;
      color: white;
    }
    
    h1 {
      font-size: 36px;
      font-weight: 800;
      background: linear-gradient(45deg, var(--primary), #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }
    
    /* Card Styles */
    .card {
      background: var(--card-bg);
      border-radius: 25px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
      padding: 40px;
      margin: 0 auto;
      max-width: 700px;
      position: relative;
      overflow: hidden;
      border: 1px solid var(--card-border);
      background-image: var(--card-gradient);
      animation: cardAppear 0.8s cubic-bezier(0.23, 1, 0.32, 1);
    }
    
    @keyframes cardAppear {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .card-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 30px;
      position: relative;
    }
    
    .theme-toggle {
      position: absolute;
      top: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: var(--gray);
      box-shadow: 0 5px 15px var(--shadow);
      transition: var(--transition);
      z-index: 10;
    }
    
    .theme-toggle:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 20px var(--shadow);
    }
    
    /* Form Styles */
    .form-group {
      margin-bottom: 25px;
      animation: slideIn 0.5s ease-out;
      animation-fill-mode: backwards;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-15px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text);
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .input-group {
      position: relative;
    }
    
    input, select {
      width: 100%;
      padding: 16px 60px 16px 20px;
      border: 1px solid var(--dark-gray);
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.1);
      font-size: 16px;
      transition: var(--transition);
      color: var(--text);
      box-shadow: 0 3px 10px var(--shadow);
    }
    
    input:focus, select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    
    .input-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--text-light);
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }
    
    .input-icon:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--primary);
    }
    
    .error-message {
      color: var(--error);
      font-size: 14px;
      margin-top: 8px;
      display: none;
    }
    
    /* Button Styles */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 25px;
    }
    
    button {
      flex: 1 1 48%;
      padding: 16px;
      border: none;
      border-radius: 15px;
      font-weight: 600;
      font-size: 17px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 5px 15px var(--shadow);
      position: relative;
      overflow: hidden;
      z-index: 1;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: -1;
    }
    
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px var(--shadow);
    }
    
    button:active {
      transform: translateY(1px);
      box-shadow: 0 3px 10px var(--shadow);
    }
    
    .btn-encrypt {
      background: var(--primary);
      color: #fff;
    }
    
    .btn-decrypt {
      background: var(--secondary);
      color: #fff;
    }
    
    .btn-copy {
      background: #818cf8;
      color: #fff;
      display: none;
    }
    
    .btn-qr {
      background: var(--purple);
      color: white;
      display: none;
    }
    
    /* Output Styles */
    pre {
      background: rgba(255, 255, 255, 0.05);
      padding: 25px;
      border-left: 4px solid var(--primary);
      border-radius: 15px;
      margin-top: 25px;
      font-size: 16px;
      white-space: pre-wrap;
      color: var(--text);
      font-family: 'Courier New', monospace;
      cursor: pointer;
      box-shadow: 0 5px 15px var(--shadow);
      transition: var(--transition);
      max-height: 250px;
      overflow-y: auto;
      line-height: 1.6;
    }
    
    pre:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px var(--shadow);
    }
    
    pre.success {
      border-left-color: var(--success);
    }
    
    pre.error {
      border-left-color: var(--error);
    }
    
    /* QR Modal Styles - Improved */
    .qr-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .qr-modal.active {
      display: flex;
    }
    
    .qr-modal-content {
      background: var(--dark-blue);
      border-radius: 20px;
      padding: 40px;
      width: 90%;
      max-width: 600px;
      text-align: center;
      position: relative;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
      border: 2px solid var(--gold);
      overflow: hidden;
      animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .qr-modal-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, var(--gold), var(--silver));
    }
    
    .qr-modal-content::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.1) 0%, transparent 30%),
        radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.1) 0%, transparent 30%),
        linear-gradient(to bottom, rgba(12, 29, 47, 0.9), rgba(9, 25, 40, 0.95));
      z-index: -1;
    }
    
    .qr-modal-header {
      margin-bottom: 30px;
      position: relative;
    }
    
    .qr-modal-title {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 10px;
      color: var(--gold);
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }
    
    .qr-modal-subtitle {
      color: var(--primary-light);
      font-size: 18px;
      margin-top: 5px;
    }
    
    .qr-modal-body {
      margin: 30px 0;
      position: relative;
    }
    
    .qr-code-container {
      background: white;
      padding: 20px;
      border-radius: 15px;
      display: inline-block;
      margin: 0 auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .qr-overlay-logo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70px;
      height: 70px;
      background: var(--primary);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }
    
    .qr-overlay-logo i {
      font-size: 36px;
      color: white;
    }
    
    .qr-info {
      margin-top: 30px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      text-align: left;
      border-left: 3px solid var(--gold);
    }
    
    .qr-info-item {
      display: flex;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .qr-info-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    
    .qr-info-label {
      width: 150px;
      font-weight: 600;
      color: var(--primary-light);
    }
    
    .qr-info-value {
      flex: 1;
      color: white;
      font-family: 'Courier New', monospace;
      word-break: break-all;
    }
    
    .telegram-section {
      background: linear-gradient(45deg, #0088cc, #2AABEE);
      border-radius: 12px;
      padding: 15px;
      margin-top: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .telegram-section i {
      font-size: 28px;
      color: white;
    }
    
    .telegram-section span {
      color: white;
      font-weight: 600;
      font-size: 18px;
    }
    
    .qr-modal-footer {
      margin-top: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }
    
    .btn-modal {
      padding: 14px 30px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 17px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 200px;
      justify-content: center;
    }
    
    .btn-download {
      background: linear-gradient(45deg, var(--gold), var(--silver));
      color: #333;
      font-weight: 700;
    }
    
    .btn-download:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
    }
    
    .btn-close-modal {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .btn-close-modal:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
    }
    
    .close-modal:hover {
      background: var(--error);
      color: white;
      transform: rotate(90deg);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .card {
        padding: 25px 15px;
      }
      
      button {
        flex: 1 1 100%;
        padding: 14px;
      }
      
      .theme-toggle {
        top: 20px;
        right: 20px;
        width: 45px;
        height: 45px;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .qr-modal-content {
        padding: 25px;
      }
      
      .qr-modal-title {
        font-size: 26px;
      }
      
      .qr-info {
        padding: 15px;
      }
      
      .qr-info-item {
        flex-direction: column;
      }
      
      .qr-info-label {
        width: 100%;
        margin-bottom: 5px;
      }
    }
    
    /* Decorative Elements */
    .grid-dots {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
      background-size: 20px 20px;
      z-index: -1;
    }
    
    .glowing-line {
      position: absolute;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--primary), transparent);
      animation: glowLine 5s infinite linear;
      z-index: -1;
    }
    
    @keyframes glowLine {
      0% { opacity: 0; left: -50%; }
      50% { opacity: 1; }
      100% { opacity: 0; left: 150%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo-container">
        <div class="logo">
          <i class="fas fa-spider"></i>
        </div>
        <h1>SpiderTrader License Generator</h1>
      </div>
    </header>
    
    <div class="card">
      <div class="theme-toggle" onclick="toggleDarkMode()">
        <i class="fas fa-moon"></i>
      </div>
      
      <div class="card-header">
        <p style="margin-bottom: 20px; color: var(--text-light);">Generate secure licenses for SpiderTrader MT5</p>
      </div>

      <div class="form-group">
        <label for="number"><i class="fas fa-id-card"></i> License ID</label>
        <input id="number" type="text" placeholder="e.g., 123456789" autocomplete="off">
        <div class="error-message" id="numberError">Please enter a valid numeric License ID</div>
      </div>

      <div class="form-group">
        <label for="duration"><i class="fas fa-calendar-alt"></i> Duration</label>
        <select id="duration">
          <option value="1">1 Month</option>
          <option value="3">3 Months</option>
          <option value="6">6 Months</option>
          <option value="9">9 Months</option>
          <option value="12" selected>12 Months</option>
        </select>
      </div>

      <div class="form-group">
        <label for="key"><i class="fas fa-key"></i> Encryption Key (16 characters)</label>
        <div class="input-group">
          <input id="key" type="password" maxlength="16" placeholder="Enter 16-character key" autocomplete="off">
          <button class="input-icon" id="lockBtn" onclick="toggleKeyLock()">
            <i class="fas fa-lock"></i>
          </button>
        </div>
        <div class="error-message" id="keyError">Key must be exactly 16 characters</div>
      </div>

      <div class="btn-group">
        <button class="btn-encrypt" onclick="encrypt()">
          <i class="fas fa-lock"></i>
          Encrypt License
        </button>
        
        <button class="btn-decrypt" onclick="decrypt()">
          <i class="fas fa-unlock"></i>
          Decrypt License
        </button>
        
        <button class="btn-copy" onclick="copyRaw()" id="btnCopy">
          <i class="fas fa-copy"></i>
          Copy License
        </button>
        
        <button class="btn-qr" onclick="generateQR()" id="btnQR">
          <i class="fas fa-qrcode"></i>
          Generate QR
        </button>
      </div>

      <pre id="output">üîí Your encrypted or decrypted results will appear here. Click to copy.</pre>
    </div>
  </div>
  
  <!-- Improved QR Code Modal -->
  <div class="qr-modal" id="qrModal">
    <div class="qr-modal-content">
      <div class="grid-dots"></div>
      <div class="glowing-line" style="top: 30%; width: 80%; animation-delay: 0s;"></div>
      <div class="glowing-line" style="top: 70%; width: 60%; animation-delay: 2s;"></div>
      
      <div class="close-modal" onclick="closeQRModal()">
        <i class="fas fa-times"></i>
      </div>
      
      <div class="qr-modal-header">
        <h2 class="qr-modal-title">SpiderTrader License</h2>
        <div class="qr-modal-subtitle">Your premium trading solution for MetaTrader 5</div>
      </div>
      
      <div class="qr-modal-body">
        <div class="qr-code-container">
          <div id="qrcode"></div>
          <div class="qr-overlay-logo">
            <i class="fas fa-spider"></i>
          </div>
        </div>
        
        <div class="qr-info">
          <div class="qr-info-item">
            <div class="qr-info-label">Account Number:</div>
            <div class="qr-info-value" id="qrAccount">123456789</div>
          </div>
          <div class="qr-info-item">
            <div class="qr-info-label">License Key:</div>
            <div class="qr-info-value" id="qrLicense">U2FsdGVkX1+...</div>
          </div>
          <div class="qr-info-item">
            <div class="qr-info-label">Software:</div>
            <div class="qr-info-value">SpiderTrader for MetaTrader 5</div>
          </div>
        </div>
        
        <div class="telegram-section">
          <i class="fab fa-telegram"></i>
          <span>Join our Telegram: @SpiderTrader_Official</span>
        </div>
      </div>
      
      <div class="qr-modal-footer">
        <button class="btn-modal btn-download" onclick="downloadQRWithText()">
          <i class="fas fa-download"></i>
          Download License
        </button>
        <button class="btn-modal btn-close-modal" onclick="closeQRModal()">
          <i class="fas fa-times"></i>
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
    // Initialize variables
    let lastEncryptedRaw = '';
    let lastEncryptedTelegram = '';
    let lastMode = '';
    let isKeyLocked = false;
    let qrCodeInstance = null;
    let currentAccountNumber = '';
    
    // Set theme based on system preference
    function setSystemTheme() {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector('.theme-toggle i').className = 'fas fa-sun';
      } else {
        document.querySelector('.theme-toggle i').className = 'fas fa-moon';
      }
    }

    // Toggle dark mode
    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      
      // Update icon
      const icon = document.querySelector('.theme-toggle i');
      if (document.body.classList.contains('dark')) {
        icon.className = 'fas fa-sun';
      } else {
        icon.className = 'fas fa-moon';
      }
    }

    // Toggle key lock
    function toggleKeyLock() {
      isKeyLocked = !isKeyLocked;
      const lockBtn = document.getElementById('lockBtn');
      const keyInput = document.getElementById('key');
      
      if (isKeyLocked) {
        lockBtn.innerHTML = '<i class="fas fa-lock"></i>';
        keyInput.disabled = true;
      } else {
        lockBtn.innerHTML = '<i class="fas fa-lock-open"></i>';
        keyInput.disabled = false;
      }
    }

    // Pad key to 16 characters
    function padKey(k) {
      return CryptoJS.enc.Utf8.parse(k.padEnd(16, '\0').slice(0, 16));
    }

    // Encryption function
    function encrypt() {
      const num = document.getElementById('number').value.trim();
      const months = parseInt(document.getElementById('duration').value, 10);
      const keyVal = document.getElementById('key').value.trim();
      const outputEl = document.getElementById('output');
      const btnCopy = document.getElementById('btnCopy');
      const btnQR = document.getElementById('btnQR');
      const numberError = document.getElementById('numberError');
      const keyError = document.getElementById('keyError');
      
      // Reset errors
      numberError.style.display = 'none';
      keyError.style.display = 'none';
      outputEl.classList.remove('success', 'error');
      closeQRModal(); // Close QR modal
      
      // Validate inputs
      let isValid = true;
      
      if (!/^\d+$/.test(num)) {
        numberError.style.display = 'block';
        isValid = false;
      }
      
      if (keyVal.length !== 16) {
        keyError.style.display = 'block';
        isValid = false;
      }
      
      if (!isValid) {
        outputEl.textContent = 'Please fix the errors above';
        outputEl.classList.add('error');
        btnCopy.style.display = 'none';
        btnQR.style.display = 'none';
        return;
      }
      
      // Save account number for QR code
      currentAccountNumber = num;
      
      // Calculate timestamp
      const ts = Math.floor(new Date().setMonth(new Date().getMonth() + months) / 1000;
      const plaintext = `TRADER${num}SPIDER${ts}`;

      // Encrypt
      try {
        lastEncryptedRaw = CryptoJS.AES.encrypt(plaintext, padKey(keyVal), {
          mode: CryptoJS.mode.ECB,
          padding: CryptoJS.pad.Pkcs7
        }).toString();
        
        lastEncryptedTelegram = '`' + lastEncryptedRaw + '`';
        lastMode = 'encrypt';
        
        const dateStr = new Date(ts * 1000).toLocaleString();
        outputEl.textContent = `‚úÖ ENCRYPTED SUCCESSFULLY\n\nüîë Encrypted License Key:\n${lastEncryptedRaw}\n\n‚è∞ Expiration Date:\n${dateStr}\n\n‚åõ Unix Timestamp: ${ts}`;
        outputEl.classList.add('success');
        btnCopy.style.display = 'inline-block';
        btnQR.style.display = 'inline-block';
        
        // Auto-scroll to output
        outputEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } catch (error) {
        outputEl.textContent = '‚ùå Encryption failed: ' + error.message;
        outputEl.classList.add('error');
        btnCopy.style.display = 'none';
        btnQR.style.display = 'none';
      }
    }

    function decrypt() {
      const prefix = 'TRADER';
      const suffix = 'SPIDER';
      const encrypted = prompt('Paste encrypted Base64:');
      const keyStr   = document.getElementById('key').value.trim();
      const outputEl = document.getElementById('output');
      const btnQR = document.getElementById('btnQR');
      
      // Validate presence
      if (!encrypted || keyStr.length !== 16) {
        outputEl.textContent = '‚ö†Ô∏è Missing encrypted text or key (must be 16 characters)';
        outputEl.className = 'error';
        btnQR.style.display = 'none';
        closeQRModal();
        return;
      }

      // Decrypt
      let raw = '';
      try {
        const bytes = CryptoJS.AES.decrypt(encrypted, padKey(keyStr), {
          mode: CryptoJS.mode.ECB,
          padding: CryptoJS.pad.Pkcs7
        });
        raw = bytes.toString(CryptoJS.enc.Utf8);
      } catch (e) {
        raw = '';
      }

      // Always show raw
      let message = `üîì Raw Decrypted:\n${raw}\n\n`;

      // Attempt to parse the decrypted text
      let parsed = false;
      try {
        // Check for valid format
        if (!raw.startsWith(prefix) || !raw.includes(suffix)) throw 'Invalid format';
        
        const body = raw.slice(prefix.length);
        const parts = body.split(suffix);
        if (parts.length !== 2) throw 'Invalid structure';
        
        const [num, tsPart] = parts;
        const ts = parseInt(tsPart, 10);
        const dateStr = new Date(ts * 1000).toLocaleString();
        const nowSec = Math.floor(Date.now() / 1000);
        const expired = ts < nowSec;

        message += `‚úÖ Parsed OK\n` +
                   `üîë License ID: ${num}\n` +
                   `‚è∞ Expiration: ${dateStr} (Unix: ${ts})\n` +
                   `${expired ? '‚ùå LICENSE EXPIRED' : '‚úÖ LICENSE ACTIVE'}`;
        outputEl.className = expired ? 'error' : 'success';
        parsed = true;
      } catch (err) {
        // If the format is wrong, just show the raw data with warning
        message += `‚ö†Ô∏è Parsing warning: ${err}`;
        outputEl.className = 'warning';
      }

      // Display the message
      outputEl.textContent = message
      outputEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      lastMode = 'decrypt';
      btnQR.style.display = 'none';
      closeQRModal();
    }

    // Copy raw function
    async function copyRaw() {
      if (!lastEncryptedRaw) return;
      
      try {
        await navigator.clipboard.writeText(lastEncryptedRaw);
        showNotification('‚úÖ Raw license key copied to clipboard!', 'success');
      } catch {
        showNotification('‚ùå Failed to copy', 'error');
      }
    }

    // Show notification
    function showNotification(message, type = '') {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      
      document.body.appendChild(notification);
      
      // Fade in
      setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(-50%) translateY(0)';
      }, 10);
      
      // Fade out and remove after 2.5 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(-50%) translateY(20px)';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 2500);
    }
    
    // Generate QR Code
    function generateQR() {
      // Only generate QR for encrypted content
      if (lastMode !== 'encrypt') {
        showNotification('QR Code is only available for encrypted licenses', 'warning');
        return;
      }
      
      if (lastEncryptedRaw) {
        showQRCodeModal(lastEncryptedRaw);
      } else {
        showNotification('No encrypted data available for QR code', 'warning');
      }
    }
    
    // Show QR Code in modal
    function showQRCodeModal(content) {
      if (!content) {
        showNotification('No content to generate QR code', 'error');
        return;
      }
      
      // Clear previous QR Code
      const qrElement = document.getElementById('qrcode');
      qrElement.innerHTML = '';
      
      // Create new QR Code
      qrCodeInstance = new QRCode(qrElement, {
        text: content,
        width: 250,
        height: 250,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
      
      // Update license info
      document.getElementById('qrAccount').textContent = currentAccountNumber;
      document.getElementById('qrLicense').textContent = content.substring(0, 20) + '...' + content.substring(content.length - 10);
      
      // Show modal
      document.getElementById('qrModal').classList.add('active');
    }
    
    // Close QR Modal
    function closeQRModal() {
      document.getElementById('qrModal').classList.remove('active');
      const qrElement = document.getElementById('qrcode');
      qrElement.innerHTML = '';
    }
    
    // Download QR Code with text
    function downloadQRWithText() {
      if (!qrCodeInstance) return;
      
      try {
        const canvas = document.querySelector('#qrcode canvas');
        const accountNum = currentAccountNumber;
        const licenseKey = lastEncryptedRaw;
        
        // Create a new canvas for the banner
        const bannerCanvas = document.createElement('canvas');
        bannerCanvas.width = 800;
        bannerCanvas.height = 600;
        const ctx = bannerCanvas.getContext('2d');
        
        // Draw background gradient (dark blue)
        const gradient = ctx.createLinearGradient(0, 0, bannerCanvas.width, bannerCanvas.height);
        gradient.addColorStop(0, '#0c1d2f');
        gradient.addColorStop(1, '#091928');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, bannerCanvas.width, bannerCanvas.height);
        
        // Draw grid dots
        ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
        for (let x = 0; x < bannerCanvas.width; x += 20) {
          for (let y = 0; y < bannerCanvas.height; y += 20) {
            ctx.beginPath();
            ctx.arc(x, y, 1, 0, Math.PI * 2);
            ctx.fill();
          }
        }
        
        // Draw decorative lines
        ctx.strokeStyle = 'rgba(59, 130, 246, 0.2)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, 300);
        ctx.lineTo(800, 300);
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(400, 0);
        ctx.lineTo(400, 600);
        ctx.stroke();
        
        // Draw title
        ctx.font = 'bold 42px "Segoe UI", sans-serif';
        ctx.fillStyle = '#FFD700';
        ctx.textAlign = 'center';
        ctx.fillText('SpiderTrader License', bannerCanvas.width / 2, 80);
        
        // Draw subtitle
        ctx.font = '24px "Segoe UI", sans-serif';
        ctx.fillStyle = '#93c5fd';
        ctx.fillText('Premium Trading Solution for MetaTrader 5', bannerCanvas.width / 2, 120);
        
        // Draw QR code
        const qrSize = 280;
        const qrX = (bannerCanvas.width - qrSize) / 2;
        const qrY = 180;
        
        // Draw QR code background
        ctx.fillStyle = 'white';
        ctx.fillRect(qrX - 15, qrY - 15, qrSize + 30, qrSize + 30);
        ctx.drawImage(canvas, qrX, qrY, qrSize, qrSize);
        
        // Draw SpiderTrader logo in center of QR code
        ctx.fillStyle = '#3b82f6';
        ctx.fillRect(qrX + qrSize/2 - 35, qrY + qrSize/2 - 35, 70, 70);
        ctx.fillStyle = 'white';
        ctx.font = 'bold 50px "Segoe UI", sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('S', qrX + qrSize/2, qrY + qrSize/2 + 5);
        
        // Draw account info
        ctx.font = 'bold 32px "Segoe UI", sans-serif';
        ctx.fillStyle = '#FFD700';
        ctx.textAlign = 'center';
        ctx.fillText(`Account: ${accountNum}`, bannerCanvas.width / 2, qrY + qrSize + 60);
        
        // Draw license key
        ctx.font = '20px "Courier New", monospace';
        ctx.fillStyle = '#93c5fd';
        ctx.fillText(licenseKey.substring(0, 40) + '...', bannerCanvas.width / 2, qrY + qrSize + 100);
        
        // Draw Telegram info
        ctx.font = 'bold 26px "Segoe UI", sans-serif';
        ctx.fillStyle = '#34d399';
        ctx.fillText('Telegram Channel: @SpiderTrader_Official', bannerCanvas.width / 2, qrY + qrSize + 160);
        
        // Draw footer
        ctx.font = '18px "Segoe UI", sans-serif';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
        ctx.fillText('¬© 2023 SpiderTrader. All rights reserved.', bannerCanvas.width / 2, bannerCanvas.height - 40);
        
        // Convert to data URL
        const dataURL = bannerCanvas.toDataURL('image/png');
        
        // Create download link
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = `spidertrader-license-${accountNum}.png`;
        link.click();
        
        showNotification('‚úÖ License banner downloaded!', 'success');
      } catch (error) {
        showNotification('‚ùå Failed to download license banner', 'error');
      }
    }
    
    // Click on the <pre> copies for Telegram if encrypt, otherwise copies entire output text
    document.getElementById('output').addEventListener('click', async function() {
      const txt = this.textContent.trim();
      let toCopy = txt;

      // Always copy the decrypted text in decrypt mode
      if (lastMode === 'decrypt') {
        toCopy = txt;  // This is the decrypted output
      } else if (lastMode === 'encrypt' && lastEncryptedTelegram) {
        toCopy = lastEncryptedTelegram;  // This is the encrypted output
      }

      try {
        await navigator.clipboard.writeText(toCopy);
        showNotification('‚úÖ Copied to clipboard!', 'success');
      } catch {
        showNotification('‚ùå Copy failed', 'error');
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Set theme based on system preference
      setSystemTheme();
      
      // Update key status on input
      const keyInput = document.getElementById('key');
      keyInput.addEventListener('input', function() {
        const keyError = document.getElementById('keyError');
        if (this.value.length === 16) {
          keyError.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>